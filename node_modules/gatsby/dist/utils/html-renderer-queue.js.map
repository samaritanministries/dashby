{"version":3,"sources":["../../src/utils/html-renderer-queue.js"],"names":["Promise","require","convertHrtime","Worker","default","numWorkers","chunk","workerPool","resolve","forkOptions","silent","module","exports","htmlComponentRendererPath","pages","activity","reject","envVars","Object","entries","NODE_ENV","process","env","gatsby_executing_command","gatsby_log_level","start","hrtime","segments","finished","map","pageSegment","renderHTML","paths","then","length","setStatus","seconds","toFixed","catch"],"mappings":";;AAAA,MAAMA,UAAUC,QAAS,UAAT,CAAhB;;AACA,MAAMC,gBAAgBD,QAAS,gBAAT,CAAtB;;AACA,MAAME,SAASF,QAAS,aAAT,EAAuBG,OAAtC;;AACA,MAAMC,aAAaJ,QAAS,oBAAT,KAAiC,CAApD;;iBACkBA,QAAS,QAAT,C;MAAVK,K,YAAAA,K;;AAER,MAAMC,aAAa,IAAIJ,MAAJ,CAAWF,QAAQO,OAAR,CAAiB,UAAjB,CAAX,EAAwC;AACzDH,YADyD;AAEzDI,eAAa;AACXC,YAAQ;AADG;AAF4C,CAAxC,CAAnB;;AAOAC,OAAOC,OAAP,GAAiB,CAACC,yBAAD,EAA4BC,KAA5B,EAAmCC,QAAnC,KACf,IAAIf,OAAJ,CAAY,CAACQ,OAAD,EAAUQ,MAAV,KAAqB;AAC/B;AACA;AACA,QAAMC,UAAUC,OAAOC,OAAP,CAAe;AAC7BC,cAAUC,QAAQC,GAAR,CAAYF,QADO;AAE7BG,8BAA0BF,QAAQC,GAAR,CAAYC,wBAFT;AAG7BC,sBAAkBH,QAAQC,GAAR,CAAYE;AAHD,GAAf,CAAhB;AAMA,QAAMC,QAAQJ,QAAQK,MAAR,EAAd;AACA,QAAMC,WAAWrB,MAAMQ,KAAN,EAAa,EAAb,CAAjB;AACA,MAAIc,WAAW,CAAf;AAEA5B,UAAQ6B,GAAR,CACEF,QADF,EAEEG,eACE,IAAI9B,OAAJ,CAAY,CAACQ,OAAD,EAAUQ,MAAV,KAAqB;AAC/BT,eACGwB,UADH,CACc;AACVlB,+BADU;AAEVmB,aAAOF,WAFG;AAGVb;AAHU,KADd,EAMGgB,IANH,CAMQ,MAAM;AACVL,kBAAYE,YAAYI,MAAxB;;AACA,UAAInB,QAAJ,EAAc;AACZA,iBAASoB,SAAT,CACG,GAAEP,QAAS,IAAGd,MAAMoB,MAAO,IAAG,CAC7BN,WAAW1B,cAAcmB,QAAQK,MAAR,CAAeD,KAAf,CAAd,EAAqCW,OADnB,EAE7BC,OAF6B,CAErB,CAFqB,CAElB,eAHf;AAKD;;AACD7B;AACD,KAhBH,EAiBG8B,KAjBH,CAiBStB,MAjBT;AAkBD,GAnBD,CAHJ,EAwBGiB,IAxBH,CAwBQzB,OAxBR,EAyBG8B,KAzBH,CAyBStB,MAzBT;AA0BD,CAvCD,CADF","sourcesContent":["const Promise = require(`bluebird`)\nconst convertHrtime = require(`convert-hrtime`)\nconst Worker = require(`jest-worker`).default\nconst numWorkers = require(`physical-cpu-count`) || 1\nconst { chunk } = require(`lodash`)\n\nconst workerPool = new Worker(require.resolve(`./worker`), {\n  numWorkers,\n  forkOptions: {\n    silent: false,\n  },\n})\n\nmodule.exports = (htmlComponentRendererPath, pages, activity) =>\n  new Promise((resolve, reject) => {\n    // We need to only pass env vars that are set programatically in gatsby-cli\n    // to child process. Other vars will be picked up from environment.\n    const envVars = Object.entries({\n      NODE_ENV: process.env.NODE_ENV,\n      gatsby_executing_command: process.env.gatsby_executing_command,\n      gatsby_log_level: process.env.gatsby_log_level,\n    })\n\n    const start = process.hrtime()\n    const segments = chunk(pages, 50)\n    let finished = 0\n\n    Promise.map(\n      segments,\n      pageSegment =>\n        new Promise((resolve, reject) => {\n          workerPool\n            .renderHTML({\n              htmlComponentRendererPath,\n              paths: pageSegment,\n              envVars,\n            })\n            .then(() => {\n              finished += pageSegment.length\n              if (activity) {\n                activity.setStatus(\n                  `${finished}/${pages.length} ${(\n                    finished / convertHrtime(process.hrtime(start)).seconds\n                  ).toFixed(2)} pages/second`\n                )\n              }\n              resolve()\n            })\n            .catch(reject)\n        })\n    )\n      .then(resolve)\n      .catch(reject)\n  })\n"],"file":"html-renderer-queue.js"}